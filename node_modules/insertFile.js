var mserve = require('frontEnd');
var qs = require('querystring');
var gp = require('gasParse');
var hp = require('htmlPage');
var myl = require('mysqlLink');


withFileNum = function(err, rows, fields, inst)
{
	var filenum = 0;
	if (err)
	{
		console.log(JSON.stringify(err));
		return;
	}

	if (rows.length < 1)
	{
		console.log(JSON.stringify(rows));
		return;
	}

	filenum = rows[0].file_id;

	myl.addInstRows(filenum, inst);
}

start = function(req, res)
{
	if (req.body)
	{
		var bodydata = qs.parse(req.body);
		var rows = gp.eatGas(bodydata.payload);
		var filename = bodydata.filename;
		var page = new hp.page(res);
		var ops = gp.getOpCodeList(rows);
		var max_inst = 0;
		var max_direct = 0;
		var max_comment = 0;
		var max_label = 0;

		page.start();

		for (i = 0; i < rows.length; i++)
		{
			if (rows[i].inst.length > max_inst)
			{
				max_inst = rows[i].inst.length;
			}
			if (rows[i].comment.length > max_comment)
			{
				max_comment = rows[i].comment.length;
			}
			if (rows[i].direct.length > max_direct)
			{
				max_direct = rows[i].direct.length;
			}
			if (rows[i].label.length > max_label)
			{
				max_label = rows[i].label.length;
			}
		}

		page.write("<h3>Filename</h3>" + filename);
		page.write("<h3>Max Instruction</h3>" + max_inst + "\n");
		page.write("<h3>Max Comment</h3>" + max_comment + "\n");
		page.write("<h3>Max Direct</h3>" + max_direct + "\n");
		page.write("<h3>Max Label</h3>" + max_label + "\n");
		page.write("<h3>Found Op Codes:</h1>\n")

		for (var key in ops)
		{
			page.write(key + " \n");
			myl.addOpCode(key);
		}
 
		page.write("<h3>Total Lines:</h3>\n");
		page.write(rows.length + "\n");

		page.write("<table border=1 cellpadding=3>\n");
		for (i = 0; i < rows.length; i++)
		{
			page.write("\t" + rows[i].tableRow() + "\n");
		}
		page.write("</table>");

		page.end();

		myl.addFile(filename);
		myl.addOpCode("");

		myl.getFileNum(filename, rows, withFileNum);
	}

	else
	{
		mserve.staticContent("addfile.htm", req, res);	
	}
}


module.exports.start = start;
