var qs = require('querystring');
var url = require('url');
var path = require('path');
var fs = require('fs');
var insfile = require('insertFile');
var hp = require('htmlPage');

testExistance = function(exists, fullpath, req, res)
{
	if (exists)
	{
		var file = fs.createReadStream(fullpath);
		res.writeHead(200, {'Content-Type': 'text/html'});
		file.setEncoding('utf8');
		file.on('data', function (data) { res.write(data); });
		file.on('end', function () { res.end(); });
	}

	else
	{
		res.writeHead(404, {'Content-Type': 'text/html'});
		res.end("file: " + fullpath + " not found.");
	}
}

staticContent = function(filename, req, res)
{
	var fullpath = path.normalize("static/" + path.normalize(filename));
	path.exists(fullpath, function (exists) { testExistance(exists, fullpath, req, res); } );
}

start = function(req, res)
{
	var args = url.parse(req.url, true);

	if (args.pathname.substr(0,8) == "/addfile")
	{
		insfile.start(req, res);
	}
	else if (args.pathname.substr(0,4) == "/css")
	{
		staticContent(args.pathname, req, res);
	}

	else
	{
		var page = new hp.page(res);

		page.start();
		page.write(JSON.stringify(req.body));
		page.write(JSON.stringify(args));
		page.end();
	}
}

module.exports.staticContent = staticContent;
module.exports.start = start;

