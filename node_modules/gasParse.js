const MODE_START = 1;
const MODE_STR = 4;

getPieces = function(data, delim)
{
	var i, last = 0;
	var output = [];

	for (i = 0; i < data.length; i++)
	{
		if (data[i] == delim)
		{
			output.push(data.substr(last, i-last));
			last = i + 1;
		}
	}

	output.push(data.substr(last, i-last));

	return output;
}

gasRow = function()
{
	this.label = "";
	this.inst = "";
	this.direct = "";
	this.comment = "";

	this.tableRow = function()
	{
		return "<tr><td>" + this.label 
			+ "</td><td>" + this.inst
			+ "</td><td>" + this.direct
			+ "</td><td>" + this.comment
			+ "</td></tr>";
	}
}

parseGasRow = function(data)
{
	var output = new gasRow();
	var i;
	var mode = MODE_START;
	var temp = "";
	var directivefound = false;
	var oncomment = false;

	for (i = 0; i < data.length; i++)
	{
		if (mode == MODE_START)
		{
			if (data[i] == '"')
			{
				temp += data[i];
				mode = MODE_STR;
			}
			else if (data[i] == '\'')
			{
				temp += data[i];
				mode = MODE_STRS;
			}
			else if (data[i] == ':')
			{
				output.label = temp;
				temp = "";
				labelfound = true;
			}
			else if (data[i] == '.')
			{
				directivefound = true;
			}
			else if (data[i] == ';')
			{
				output.inst = temp;
				temp = "";
				oncomment = true;
			}
			else
			{
				temp += data[i];
			}
		}
		else if (mode == MODE_STR)
		{
			if (data[i] == '\\' && i+1 < data.length)
			{
				temp += data[i];
				i++;
				temp += data[i];
			}
			else if (data[i] == '"')
			{
				temp += data[i];
				mode = MODE_START
			}
			else
			{
				temp += data[i];
			}
		}
		else if (mode == MODE_STRS)
		{
			if (data[i] == '\\' && i+1 < data.length)
			{
				temp += data[i];
				i++;
				temp += data[i];
			}
			else if (data[i] == '\'')
			{
				temp += data[i];
				mode = MODE_START
			}
			else
			{
				temp += data[i];
			}
		}
	}

	if (oncomment)
	{
		output.comment += temp;
	}
	else if (directivefound)
	{
		output.direct += temp;
	}
	else
	{
		output.inst += temp;
	}

	return output;
}

eatGas = function(data)
{
	var rows = getPieces(data, '\n');
	var output = [];
	var i;

	for (i = 0; i < rows.length; i++)
	{
		output.push(parseGasRow(rows[i]));
	}

	return output;
}

module.exports.getPieces = getPieces;
module.exports.eatGas = eatGas;
