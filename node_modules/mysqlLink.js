var mysql = require('mysql');

var server = "127.0.0.1";
var user = "gas";
var password = "gas";
var database = "gasview";

const add_file_name_table = "CREATE TABLE files ( "
	+"file_id	INTEGER PRIMARY KEY AUTO_INCREMENT, "
	+"filename	VARCHAR(45) UNIQUE, "
	+"created	TIMESTAMP DEFAULT CURRENT_TIMESTAMP"
	+")";

const add_opcode_table = "CREATE TABLE opcodes ( "
	+"code		VARCHAR(10) PRIMARY KEY, "
	+"created	TIMESTAMP DEFAULT CURRENT_TIMESTAMP "
	+") ";

const add_instrow_table = "CREATE TABLE instrow ( "
	+"file_id	INTEGER NOT NULL, "
	+"line_num	INTEGER NOT NULL, "
	+"chunk_num	INTEGER NOT NULL, "
	+"label		VARCHAR(200), "
	+"inst		VARCHAR(200), "
	+"direct	VARCHAR(200), "
	+"comment	VARCHAR(200), "
	+"opcode	VARCHAR(10) NOT NULL, "
	+"created	TIMESTAMP DEFAULT CURRENT_TIMESTAMP, "
	+"CONSTRAINT irf1	FOREIGN KEY instrow(file_id) REFERENCES files(file_id), "
	+"CONSTRAINT irf2	FOREIGN KEY instrow(opcode) REFERENCES opcodes(code) "
	+") ";

const add_instrow_index = "CREATE UNIQUE INDEX idx_instrow ON instrow (file_id, line_num)"

const drop_instrow_index = "DROP INDEX idx_instrow ON instrow";

const drop_file_name_table = "DROP TABLE files";
const drop_opcode_table = "DROP TABLE opcodes";
const drop_instrow_table = "DROP TABLE instrow";


genericMySQLReturn = function(err,rows,fields)
{
	if (true)
	{
		console.log(JSON.stringify(err));
		console.log(JSON.stringify(rows));
		console.log(JSON.stringify(fields));
	}
}

addTables = function()
{
	var connection = mysql.createConnection({host: server, user: user, password: password, database:database});

	connection.query(drop_instrow_index, genericMySQLReturn);
	connection.query(drop_instrow_table, genericMySQLReturn);
	connection.query(drop_file_name_table, genericMySQLReturn);
	connection.query(drop_opcode_table, genericMySQLReturn);
	
	connection.query(add_file_name_table, genericMySQLReturn);
	connection.query(add_opcode_table, genericMySQLReturn);
	connection.query(add_instrow_table, genericMySQLReturn);
	connection.query(add_instrow_index, genericMySQLReturn);

	connection.end();
}

addFile = function(filename)
{
	var connection = mysql.createConnection({host: server, user: user, password: password, database:database});

	connection.query("INSERT OR IGNORE INTO files(filename) VALUES ('" + filename + "')", genericMySQLReturn);

	connection.end();
}

addOpCode = function(opcode)
{
	var connection = mysql.createConnection({host: server, user: user, password: password, database:database});

	connection.query("INSERT OR IGNORE INTO opcode(code) VALUES ('" + opcode + "')", genericMySQLReturn);

	connection.end();
}

module.exports.addFile = addFile;
module.exports.addOpCode = addOpCode;
module.exports.addTables = addTables;
